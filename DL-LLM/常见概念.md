
## é€šä¿¡æ“ä½œ(åŸè¯­)

**All-Reduceã€All-Gatherã€Reduceã€Reduce-Scatterã€Broadcastã€Scatterã€Gather** ç­‰
### ğŸŒ ä¸€ã€é€šä¿¡æ“ä½œçš„æ•´ä½“æ¦‚å¿µ

è¿™äº›æ“ä½œéƒ½æ˜¯**collective communicationï¼ˆé›†åˆé€šä¿¡ï¼‰** çš„ä¸€éƒ¨åˆ†ï¼Œç”± MPIã€NCCLã€Gloo ç­‰é€šä¿¡åº“åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­å®ç°ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ N ä¸ªè®¾å¤‡ï¼ˆGPU/èŠ‚ç‚¹ï¼‰ï¼Œæ¯ä¸ªè®¾å¤‡ä¸Šéƒ½æœ‰ä¸€ä»½å¼ é‡ $x_i$ã€‚

### ğŸ§© äºŒã€å¸¸è§é€šä¿¡æ“ä½œå¯¹æ¯”

| **æ“ä½œå**            | çœæµ               | **å«ä¹‰**                            | **è¾“å…¥/è¾“å‡º**                     | **å¸¸ç”¨åœºæ™¯**                   |
| ------------------ | ---------------- | --------------------------------- | ----------------------------- | -------------------------- |
| **Broadcast**      | å¤åˆ¶-åˆ†å‘            | å°†ä¸€ä¸ªè®¾å¤‡çš„æ•°æ®å‘é€ç»™æ‰€æœ‰è®¾å¤‡                   | rank 0 çš„å¼ é‡ â†’ æ‰€æœ‰ rank æ‹¥æœ‰ç›¸åŒå‰¯æœ¬   | å‚æ•°åˆå§‹åŒ–ã€æ¨¡å‹åŠ è½½                 |
| **Reduce**         | Gather+è®¡ç®—        | å°†æ‰€æœ‰è®¾å¤‡çš„æ•°æ®æŒ‰æŸç§æ–¹å¼ï¼ˆå¦‚æ±‚å’Œï¼‰åˆå¹¶åˆ°ä¸€ä¸ªè®¾å¤‡         | æ‰€æœ‰ rank çš„å¼ é‡ â†’ ç›®æ ‡ rank å¾—åˆ°åˆå¹¶ç»“æœ  | åªåœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šæ”¶é›†æ¢¯åº¦                |
| **All-Reduce**     |                  | Reduce + **Broadcast**ï¼šæ‰€æœ‰è®¾å¤‡å¾—åˆ°åˆå¹¶ç»“æœ | æ¯ä¸ª rank çš„å¼ é‡ â†’ æ‰€æœ‰ rank å¾—åˆ°åˆå¹¶ç»“æœ  | åŒæ­¥æ¢¯åº¦æ±‚å¹³å‡                    |
| **Gather**         | æ”¶é›†åˆ‡ç‰‡             | å°†æ¯ä¸ªè®¾å¤‡çš„æ•°æ®æ”¶é›†åˆ°ä¸€ä¸ªè®¾å¤‡                   | rank i çš„å¼ é‡ â†’ rank 0 æ”¶é›†æ‰€æœ‰      | æ±‡æ€»æ—¥å¿—ã€æ”¶é›†åˆ†ç‰‡è¾“å‡º                |
| **All-Gather**     | Gather+Broadcast | æ‰€æœ‰è®¾å¤‡äº’ç›¸æ”¶é›†æ‰€æœ‰æ•°æ®                      | æ¯ä¸ª rank çš„å¼ é‡ â†’ æ¯ä¸ª rank å¾—åˆ°æ‹¼æ¥ç»“æœ  | åˆ†å¸ƒå¼ embeddingã€æ¨¡å‹å¹¶è¡Œ         |
| **Scatter**        | åˆ‡ç‰‡-åˆ†å‘            | å°†ä¸€ä¸ªå¤§å¼ é‡åˆ†ç‰‡å‘é€åˆ°å¤šä¸ªè®¾å¤‡                   | rank 0 çš„å¼ é‡ â†’ å„ rank å¾—åˆ°ä¸åŒåˆ†ç‰‡    | æ•°æ®å¹¶è¡Œæ•°æ®åˆ†å‘                   |
| **Reduce-Scatter** |                  | Reduce + **Scatter**ï¼šåˆå¹¶ååˆ†ç‰‡å‘é€      | å„ rank å¼ é‡æ±‚å’Œ â†’ æ¯ä¸ª rank æ‹¥æœ‰ä¸€éƒ¨åˆ†ç»“æœ | å¼ é‡åˆ‡åˆ†å¹¶è¡Œï¼ˆtensor parallelï¼‰ä¸­å¸¸è§ |
- All: å³æ¥Broadcast
### ğŸ“Š ä¸‰ã€å¯è§†åŒ–ç†è§£

> TODO: ç”»ä¸ªå›¾å§

å‡è®¾æˆ‘ä»¬æœ‰ 4 ä¸ª GPUï¼Œæ¯ä¸ª GPU ä¸Šçš„æ•°æ®æ˜¯ï¼š

GPU	æ•°æ®
0	\[1, 1]
1	\[2, 2]
2	\[3, 3]
3	\[4, 4]

####  All-Reduceï¼ˆsumï¼‰

æ¯ä¸ª GPU éƒ½ä¼šæ‹¿åˆ°æ‰€æœ‰ GPU æ•°æ®æ±‚å’Œçš„ç»“æœ

è®¡ç®—ï¼š$[1,1]+[2,2]+[3,3]+[4,4]=[10,10]$ 

ç»“æœï¼š

GPU	è¾“å‡º
0	\[10, 10]
1	\[10, 10]
2	\[10, 10]
3	\[10, 10]

è‹¥æ˜¯å¹³å‡ï¼ˆaverageï¼‰ï¼Œåˆ™ä¸º \[2.5, 2.5]ã€‚

å¸¸è§äºï¼šData Parallel çš„æ¢¯åº¦åŒæ­¥ã€‚

#### All-Gather

æ¯ä¸ª GPU éƒ½æ‹¿åˆ°æ‰€æœ‰ GPU çš„æ‹¼æ¥ç»“æœ

æ‹¼æ¥ï¼š$[1,1],[2,2],[3,3],[4,4]$ 

ç»“æœï¼š

GPU		è¾“å‡º
0	\[\[1,1],\[2,2],\[3,3],\[4,4]]
1	\[\[1,1],\[2,2],\[3,3],\[4,4]]
2	\[\[1,1],\[2,2],\[3,3],\[4,4]]
3	\[\[1,1],\[2,2],\[3,3],\[4,4]]

å¸¸è§äºï¼šTensor Parallel / Sequence Parallel ä¸­æ‹¼æ¥ä¸åŒåˆ†ç‰‡ã€‚

#### Reduce-Scatterï¼ˆsumï¼‰

å…ˆåš All-Reduce å†æŒ‰ rank æ‹†åˆ†

å…ˆæ±‚å’Œï¼š\[10, 10]ï¼Œç„¶åæ‹†åˆ† â†’ æ¯ä¸ª GPU æ‹¿åˆ°ä¸åŒéƒ¨åˆ†ã€‚

ä¾‹å¦‚ï¼š

GPU	è¾“å‡ºï¼ˆæ‹†åˆ†éƒ¨åˆ†ï¼‰
0		\[2.5]
1		\[2.5]
2		\[2.5]
3		\[2.5]

å¸¸è§äºï¼šTensor Parallel çš„åå‘ä¼ æ’­é˜¶æ®µï¼ˆæ¢¯åº¦åˆ†ç‰‡ï¼‰ã€‚



#### Broadcast

æŠŠ rank 0 çš„å¼ é‡å‘é€ç»™æ‰€æœ‰ GPU

| rank 0 æ•°æ® | [1,1] |
| æ‰€æœ‰ GPU æœ€ç»ˆéƒ½æ‹¿åˆ° | [1,1] |



### âš™ï¸ å››ã€NCCL/PyTorchä¸­çš„å®ç°ç¤ºä¾‹

```python
import torch
import torch.distributed as dist

# åˆå§‹åŒ–é€šä¿¡ç»„
dist.init_process_group("nccl")
tensor = torch.tensor([1.0, 2.0], device="cuda")

# all_reduce æ±‚å’Œ
dist.all_reduce(tensor, op=dist.ReduceOp.SUM)

# all_gather
gather_list = [torch.zeros_like(tensor) for _ in range(dist.get_world_size())]
dist.all_gather(gather_list, tensor)

# reduce_scatter
output = torch.zeros_like(tensor)
dist.reduce_scatter(output, gather_list, op=dist.ReduceOp.SUM)
```



### ğŸ§  äº”ã€æ€»ç»“å¯¹æ¯”å›¾

| **æ“ä½œ**           | **æ˜¯å¦èšåˆ** | **æ˜¯å¦å¹¿æ’­** | **æ¯ä¸ª rank ç»“æœ**   | **å¸¸è§ç”¨é€”** |
| ------------------ | ------------ | ------------ | -------------------- | ------------ |
| **Reduce**         | âœ…            | âŒ            | ä»… root rank æœ‰ç»“æœ  | æ”¶é›†æ¢¯åº¦     |
| **All-Reduce**     | âœ…            | âœ…            | æ¯ä¸ª rank ç›¸åŒ       | åŒæ­¥æ¢¯åº¦     |
| **All-Gather**     | âŒ            | âœ…            | æ¯ä¸ª rank æ‹¼æ¥æ‰€æœ‰   | æ‹¼æ¥è¾“å‡º     |
| **Reduce-Scatter** | âœ…            | âœ…ï¼ˆéƒ¨åˆ†ï¼‰    | æ¯ä¸ª rank å¾—éƒ¨åˆ†ç»“æœ | æ¨¡å‹å¹¶è¡Œ     |
| **Broadcast**      | âŒ            | âœ…            | æ¯ä¸ª rank ç›¸åŒ       | å‚æ•°åŒæ­¥     |

